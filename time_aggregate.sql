/* Michelle Tanco - 05/16/2018
 * time_aggregate.sql
 * 
 * exploring the time aggregate function
 * */

--get number of pages by day...easy
--what about nubmer of pages every 5 days? HARD
SELECT cast(tstamp as date) as dt, count(*) 
FROM retail_sessions 
group by 1
order by 1;

-- dt         Count(*) 
-- ---------- -------- 
-- 2017-01-02       21
-- 2017-01-03       24
-- 2017-01-04        8
-- 2017-01-06        4

--number of pages by day with new aggregate
--easy to change time range we are interested in
SELECT $TD_TIMECODE_RANGE
	, COUNT(*) 
FROM retail_sessions 
GROUP BY TIME (DAYS(1)) 
USING TIMECODE(tstamp) 
ORDER BY 1;

--TIMECODE_RANGE                                           Count(*) 
-- -------------------------------------------------------- -------- 
-- (2017-01-02 00:00:00.000000, 2017-01-03 00:00:00.000000)       21
-- (2017-01-03 00:00:00.000000, 2017-01-04 00:00:00.000000)       24
-- (2017-01-05 00:00:00.000000, 2017-01-06 00:00:00.000000)        8
-- (2017-01-06 00:00:00.000000, 2017-01-07 00:00:00.000000)        4


--look at number of pages for every 30 min chunk of time
SELECT $TD_TIMECODE_RANGE
	, page
	, COUNT(*) 
FROM retail_sessions 
GROUP BY TIME (MINUTES(30) AND page) 
USING TIMECODE(tstamp)  
order by 1,2;

--TIMECODE_RANGE                                           page                          Count(*) 
-- -------------------------------------------------------- ----------------------------- -------- 
-- (2017-01-02 22:30:00.000000, 2017-01-02 23:00:00.000000) ADD TO CART                          1
-- (2017-01-02 22:30:00.000000, 2017-01-02 23:00:00.000000) SEARCH                               6
-- (2017-01-02 22:30:00.000000, 2017-01-02 23:00:00.000000) VIEW PRODUCT                         7
-- (2017-01-02 23:00:00.000000, 2017-01-02 23:30:00.000000) SEARCH                               2
-- (2017-01-02 23:00:00.000000, 2017-01-02 23:30:00.000000) VIEW PRODUCT                         5
--

--fill missing values
--look at specific time ranges
SELECT 
    $TD_TIMECODE_RANGE as tm
    , COUNT(*) as numb
FROM retail_sessions 
GROUP BY TIME (HOURS(3)) 
USING TIMECODE(tstamp)  
FILL(0)
order by 1,2 WHERE tstamp 
    BETWEEN TIMESTAMP '2017-01-03 00:00:00.000000'
        AND TIMESTAMP '2017-01-04 00:00:00.000000';
        
--(2017-01-03 05:00:00.000000, 2017-01-03 08:00:00.000000),0
--(2017-01-03 08:00:00.000000, 2017-01-03 11:00:00.000000),0
--(2017-01-03 11:00:00.000000, 2017-01-03 14:00:00.000000),0
--(2017-01-03 14:00:00.000000, 2017-01-03 17:00:00.000000),0
--(2017-01-03 17:00:00.000000, 2017-01-03 20:00:00.000000),1
--(2017-01-03 20:00:00.000000, 2017-01-03 23:00:00.000000),23
--(2017-01-03 23:00:00.000000, 2017-01-04 02:00:00.000000),0
--(2017-01-04 02:00:00.000000, 2017-01-04 05:00:00.000000),0
--(2017-01-04 05:00:00.000000, 2017-01-04 05:00:00.000000),0
	
        
SELECT $TD_TIMECODE_RANGE
	, COUNT(*) 
FROM retail_to_sessionize 
GROUP BY TIME (CAL_MONTHS(2)) 
USING TIMECODE(tstamp)  ;

--TIMECODE_RANGE                                           Count(*) 
-- -------------------------------------------------------- -------- 
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000)     2184
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000)     2165


SELECT $TD_TIMECODE_RANGE
	, page
	, COUNT(*) 
FROM retail_to_sessionize 
GROUP BY TIME (CAL_MONTHS(2) AND page) 
USING TIMECODE(tstamp) 
FILL(0)
ORDER BY 1,2;

--TIMECODE_RANGE                                           page                          Count(*) 
-- -------------------------------------------------------- ----------------------------- -------- 
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) ADD TO CART                         98
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) CONFIRM ORDER                        5
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) ENTER PAYMENT INFORMATION            9
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) ENTER SHIPPING INFORMATION          18
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) HOME PAGE                           39
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) PURCHASE COMPLETE                    3
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) RETURN POLICY                        5
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) REVIEW CART                         47
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) SEARCH                             943
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) SERVER ERROR                         3
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) SHIPPING FAQ                         9
-- (2017-01-01 00:00:00.000000, 2017-03-01 00:00:00.000000) VIEW PRODUCT                      1005
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) ADD TO CART                         78
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) CONFIRM ORDER                        5
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) DELAYED SHIPPING NOTIFICATION        2
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) ENTER PAYMENT INFORMATION            5
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) ENTER SHIPPING INFORMATION           8
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) HOME PAGE                           47
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) PURCHASE COMPLETE                    3
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) REVIEW CART                         39
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) SEARCH                             923
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) SHIPPING FAQ                         5
-- (2017-03-01 00:00:00.000000, 2017-05-01 00:00:00.000000) VIEW PRODUCT                      1050


	
